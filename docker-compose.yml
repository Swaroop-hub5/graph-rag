services:
  # Service 1: The Database
  neo4j:
    image: neo4j:5.23.0
    container_name: nortal_neo4j
    ports:
      - "7474:7474" # HTTP Browser
      - "7687:7687" # Bolt Protocol
    volumes:
      - ./neo4j_data:/data
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_PLUGINS=["apoc"]
    healthcheck:
        test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 5
    restart: unless-stopped

  # Service 2: Your Streamlit App
  app:
    build: .                      # Build the Dockerfile in the current directory
    container_name: nortal_app
    ports:
      - "8501:8501"               # Map container port 8501 to your laptop's 8501
    depends_on:
      neo4j:
        condition: service_healthy # Wait until Neo4j is actually ready
    environment:
      # Pass API keys automatically
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      # IMPORTANT: Note the hostname is now 'neo4j', not 'localhost'
      - NEO4J_URI=bolt://neo4j:7687 
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    develop:
      watch:
        - action: sync
          path: ./src
          target: /app/src